name: vici-services
services:
  # API Gateway - Main entry point
  api-gateway:
    build:
      context: ..
      dockerfile: services/api-gateway/Dockerfile
    container_name: api-gateway
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      # Service URLs
      AUTH_SERVICE_URL: http://auth-service:3001
      USER_SERVICE_URL: http://user-service:5002
      PRODUCT_SERVICE_URL: http://product-service:4001
      CART_SERVICE_URL: http://cart-service:3003
      ORDER_SERVICE_URL: http://order-service:3005
      PAYMENT_SERVICE_URL: http://payment-service:3006
      # gRPC URLs
      USER_GRPC_URL: user-service:5001
      PRODUCT_GRPC_URL: product-service:4003
      INVENTORY_GRPC_URL: inventory-service:4004
      CART_GRPC_URL: cart-service:50053
      ORDER_GRPC_URL: order-service:50054
      PAYMENT_GRPC_URL: payment-service:50055
      EVENT_GRPC_URL: event-service:50056
      RECOMMENDATION_GRPC_URL: recommendation-service:4005
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-1h}
    depends_on:
      - auth-service
      - user-service
      - product-service
      - cart-service
      - order-service
    networks:
      - vici-network
    restart: unless-stopped

  # Auth Service
  auth-service:
    build:
      context: ..
      dockerfile: services/auth-service/Dockerfile
    container_name: auth-service
    ports:
      - "50051:50051"
    environment:
      NODE_ENV: production
      GRPC_PORT: 50051
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_DATABASE: ecommerce_db
      DB_SCHEMA: auth
      DB_USER: ${POSTGRES_USER}
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-1h}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-7d}
    networks:
      - vici-network
    restart: unless-stopped

  # User Service
  user-service:
    build:
      context: ..
      dockerfile: services/user-service/Dockerfile
    container_name: user-service
    ports:
      - "5001:5001"
    environment:
      NODE_ENV: production
      GRPC_PORT: 5001
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: users
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # MinIO
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: users
    networks:
      - vici-network
    restart: unless-stopped

  # Product Service (Go)
  product-service:
    build:
      context: ..
      dockerfile: services/product-service/Dockerfile
    container_name: product-service
    ports:
      - "4001:4001"
      - "4003:4003"
    environment:
      SERVICE_NAME: product-service
      PORT: 4001
      GRPC_PORT: 4003
      LOG_LEVEL: info
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      # DB_SCHEMA: products  # Using public schema with init scripts
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      # MinIO
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_BUCKET: products
      MINIO_USE_SSL: "false"
    networks:
      - vici-network
    restart: unless-stopped

  # Inventory Service (Go)
  inventory-service:
    build:
      context: ..
      dockerfile: services/inventory-service/Dockerfile
    container_name: inventory-service
    ports:
      - "4002:4002"
      - "4004:4004"
    environment:
      SERVICE_NAME: inventory-service
      PORT: 4002
      GRPC_PORT: 4004
      LOG_LEVEL: info
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: inventory
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      # Kafka
      KAFKA_BROKERS: kafka:9092
    networks:
      - vici-network
    restart: unless-stopped

  # Cart Service (Go)
  cart-service:
    build:
      context: ..
      dockerfile: services/cart-service/Dockerfile
    container_name: cart-service
    ports:
      - "3003:3003"
      - "50053:50053"
    environment:
      SERVICE_NAME: cart-service
      PORT: 3003
      GRPC_PORT: 50053
      LOG_LEVEL: info
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: carts
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      # Cart settings
      CART_ABANDONED_DAYS: 7
      CART_EXPIRY_DAYS: 30
    networks:
      - vici-network
    restart: unless-stopped

  # Order Service (Go)
  order-service:
    build:
      context: ..
      dockerfile: services/order-service/Dockerfile
    container_name: order-service
    ports:
      - "3005:3005"
      - "50054:50054"
    environment:
      SERVICE_NAME: order-service
      PORT: 3005
      GRPC_PORT: 50054
      LOG_LEVEL: info
      # Database
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/ecommerce_db?sslmode=disable&search_path=orders
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: orders
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
    networks:
      - vici-network
    restart: unless-stopped

  # Payment Service (Go)
  payment-service:
    build:
      context: ..
      dockerfile: services/payment-service/Dockerfile
    container_name: payment-service
    ports:
      - "3006:3006"      # HTTP port
      - "50055:50055"    # gRPC port
    environment:
      # Service Configuration
      SERVICE_NAME: payment-service
      PORT: 3006
      GRPC_PORT: 50055
      LOG_LEVEL: info
      
      # Database Configuration
      DATABASE_URL: postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/ecommerce_db?sslmode=disable&search_path=payments
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: payments
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      
      # Redis Configuration (Optional caching)
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379/0
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      
      # Stripe Configuration (Required)
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-pk_test_dummy}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_dummy}
      
      # Service URLs (for future inter-service communication)
      ORDER_SERVICE_GRPC: order-service:50054
      EVENT_SERVICE_GRPC: event-service:50056
    networks:
      - vici-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # Event Service (Go)
  event-service:
    build:
      context: ..
      dockerfile: services/event-service/Dockerfile
    container_name: event-service
    ports:
      - "3007:3007"
      - "50056:50056"
    environment:
      SERVICE_NAME: event-service
      PORT: 3007
      GRPC_PORT: 50056
      LOG_LEVEL: info
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: events
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSL_MODE: disable
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      # Kafka
      KAFKA_BROKERS: kafka:9092
      KAFKA_TOPIC: ecommerce-events
      KAFKA_CONSUMER_GROUP: event-service-group
    networks:
      - vici-network
    restart: unless-stopped

  # Notification Service
  notification-service:
    build:
      context: ../services/notification-service
      dockerfile: Dockerfile
    container_name: notification-service
    ports:
      - "3008:3008"
    environment:
      NODE_ENV: production
      PORT: 3008
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_DATABASE: ecommerce_db
      DB_SCHEMA: notifications
      DB_USER: ${POSTGRES_USER}
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      # Kafka
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: notification-service
      KAFKA_CONSUMER_GROUP: notification-service-group
      # Email (Example: SendGrid)
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-SG.dummy}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@vici.com}
    networks:
      - vici-network
    restart: unless-stopped

  # Recommendation Service (Go)
  recommendation-service:
    build:
      context: ..
      dockerfile: services/recommendation-service/Dockerfile
    container_name: recommendation-service
    ports:
      - "4005:4005"
    environment:
      SERVICE_NAME: recommendation-service
      GRPC_PORT: 4005
      LOG_LEVEL: info
      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ecommerce_db
      DB_SCHEMA: recommendations
      DB_USER: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_SSLMODE: disable
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
    networks:
      - vici-network
    restart: unless-stopped

networks:
  vici-network:
    external: true
    name: vici-infrastructures_vici-network
